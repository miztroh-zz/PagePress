<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="/bower_components/iron-list/iron-list.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/image-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/elements/pp-page-editor/pp-page-editor.html">
<dom-module id="pp-pages">
	<template>
		<style>
			:host {
				display: block;
			}

			@media (min-width: 768px) {
				.page {
					@apply(--layout-horizontal);
				}
			}

			@media (max-width: 767px) {
				.page {
					@apply(--layout-vertical);
				}
			}

			.page:nth-child(even) {
				background: #f5f5f5;
			}

			#add {
				margin-bottom: 15px;
			}

			iron-list {
				min-height: 100px;
			}
		</style>
		<firebase-collection location="https://ss16-page-press.firebaseio.com/pages" data="{{pages}}"></firebase-collection>
		<paper-toast id="toast"></paper-toast>
		<pp-page-editor id="editor" title="{{title}}" type="{{type}}"></pp-page-editor>
		<paper-button id="add" on-tap="add">Add</paper-button>
		<iron-list items="[[orderedPages]]" as="page">
			<template>
			<div class="page">
				<div style="padding: 15px;"><template is="dom-repeat" items="[[page.ancestors]]" as="ancestor">â€”&nbsp;</template>[[page.title]]</div>
				<div class="flex"></div>
				<div class="horizontal layout" style="padding: 5px;">
					<paper-icon-button icon="image:edit" on-tap="_edit" page-index$="[[index]]"></paper-icon-button>
					<paper-icon-button icon="open-in-new" on-tap="_view" page-index$="[[index]]"></paper-icon-button>
					<paper-icon-button icon="delete" on-tap="_delete" page-index$="[[index]]"></paper-icon-button>
				</div>
			</div>
			</template>
		</iron-list>
	</template>
	<script>
		Polymer(
			{
				is: 'pp-pages',
				properties: {
					pages: {
						type: Array
					},
					orderedPages: {
						type: Array
					},
        	index: {
        		type: Number
        	},
        	page: {
        		type: Object,
        		value: null,
        		computed: '_computePage(index)'
        	},
        	type: {
        		type: String
        	},
        	title: {
        		type: String
        	}
				},
				observers: [
					'_pagesChanged(pages.*)'
				],
        add: function () {
        	this.push(
        		'pages',
        		{
        			title: 'New Page',
        			slug: 'new-page',
        			parent: ''
        		}
        	);

					this.async(
						function () {
							this.index = this.pages.length - 1;
						},
						100
					);

					this.$.toast.text = 'Page added';
					this.$.toast.open();
        },
        _edit: function (event) {
        	this._updateIndex(event);
        	this.edit();
        },
        edit: function () {
					var page = this.orderedPages[this.index];

					if (page) {
					}
        },
				_pagesChanged: function () {
					this.async(
						function () {
							var pagesHierarchical = [], childPages = [], pagesById = {};

							for (var i = 0; i < this.pages.length; i += 1) {
								var srcPage = this.pages[i], srcPageKeys = Object.keys(srcPage);
								var newPage = {children: [], ancestors: []};

								for (var j = 0; j < srcPageKeys.length; j += 1) {
									newPage[srcPageKeys[j]] = srcPage[srcPageKeys[j]];
								}

								pagesById[srcPage.__firebaseKey__] = newPage;

								if (!newPage.parent) {
									pagesHierarchical.push(newPage);
								} else {
									childPages.push(newPage);
								}
							}

							for (i = 0; i < childPages.length; i += 1) {
								pagesById[childPages[i].parent].children.push(childPages[i]);

								(
									function (page) {
										var ancestor = pagesById[page.parent];

										while (ancestor) {
											page.ancestors.push(ancestor);
											ancestor = pagesById[ancestor.parent];
										}
									}
								)(childPages[i]);
							}

							var pagesFlat = [];

							function flattenPages (pages) {
								for (var i = 0; i < pages.length; i += 1) {
									pagesFlat.push(pages[i]);

									if (pages[i].children.length) {
										var childrenByTitle = {};

										for (var j = 0; j < pages[i].children.length; j += 1) {
											if (!childrenByTitle[pages[i].children[j].title]) childrenByTitle[pages[i].children[j].title] = [];
											childrenByTitle[pages[i].children[j].title].push(pages[i].children[j]);
										}

										var titles = Object.keys(childrenByTitle);
										titles.sort();
										var children = [];

										for (j = 0; j < titles.length; j += 1) {
											for (var k = 0; k < childrenByTitle[titles[j]].length; k += 1) {
												children.push(childrenByTitle[titles[j]][k]);
											}
										}

										flattenPages(children);
									}
								}
							}

							//console.log(pagesHierarchical);
							flattenPages(pagesHierarchical);
							//console.log(pagesFlat);
							this.orderedPages = pagesFlat;
						},
						1000
					);
				},
				_view: function (event) {
					this._updateIndex(event);
					this.view();
				},
				view: function () {
					var page = this.orderedPages[this.index];
					console.log(page);

					if (page) {
						var path = '/';

						for (var i = page.ancestors.length - 1; i >= 0; i -= 1) {
							path += page.ancestors[i].slug + '/';
						}

						path += page.slug + '/';
						window.open(path);
					}
				},
				_updateIndex: function (event) {
					var target = Polymer.dom(event).localTarget, index = +target.getAttribute('page-index');
					if (index >= 0) this.index = index;
				},
				_delete: function (event) {
					this._updateIndex(event);
					this.delete();
				},
				delete: function () {
					var page = this.orderedPages[this.index];

					if (page) {
						var pageIndexesByFirebaseKey = {};

						for (var i = 0; i < this.pages.length; i += 1) {
							pageIndexesByFirebaseKey[this.pages[i].__firebaseKey__] = i;
						}

						var pageIndex = pageIndexesByFirebaseKey[page.__firebaseKey__];

						for (i = 0; i < page.children.length; i += 1) {
							var childIndex = pageIndexesByFirebaseKey[page.children[i].__firebaseKey__];
							this.set('pages.' + childIndex + '.parent', this.pages[pageIndex].parent);
						}

						this.splice('pages', pageIndex, 1);
						this.$.toast.text = 'Page deleted';
						this.$.toast.open();
					}
				},
        _computePage: function () {
        	return this.pages[this.index];
        }
			}
		);
	</script>
</dom-module>