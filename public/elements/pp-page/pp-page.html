<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/font-roboto/roboto.html">
<link rel="import" href="/bower_components/iron-page-url/iron-page-url.html">
<link rel="import" href="/bower_components/firebase-element/firebase-collection.html">
<dom-module id="pp-page">
	<template>
		<style>
			:host {
				display: block;
				font-family: Roboto;
				width: 100vw;
				height: 100vh;
			}

			#container {
				padding: 20px;
			}

			#container > * > :first-child {
				margin-top: 0;
			}

			#container > * > :last-child {
				margin-bottom: 0;
			}
		</style>
		<firebase-collection location="https://ss16-page-press.firebaseio.com/pages" id="pages"></firebase-collection>
		<firebase-collection location="[[_pageLocation(key)]]" id="page" data="{{_page}}"></firebase-collection>
		<iron-page-url path="{{path}}" url-space-regex="^(?!/dashboard/)"></iron-page-url>
		<div id="container">
			<div id="error404" hidden$="[[page]]">
				<h1>
					<span hidden$="[[!error]]">404</span>
				</h1>
			</div>
			<div id="page" hidden$="[[!page]]">
				<h1>[[page.title]]</h1>
				<template is="dom-repeat" items="[[page.blocks]]" as="block">
					<template is="dom-if" if="[[_equalTo(block.name, 'placeholder')]]">
						<div inner-h-t-m-l="[[block.value]]"></div>
					</template>
				</template>
			</div>
		</div>
	</template>
	<script>
		Polymer(
			{
				is: 'pp-page',
				properties: {
					path: {
						type: String,
						observer: '_pathChanged'
					},
					key: {
						type: String,
						value: null
					},
					page: {
						type: Object
					},
					_page: {
						type: Array
					},
					error: {
						type: Boolean,
						value: false
					}
				},
				observers: [
					'_pageTitleChanged(page.*)',
					'__pageChanged(_page.*)'
				],
				_equalTo: function (a, b) {
					return a === b;
				},
				_pathChanged: function () {
					this.key = '';
					var path = this.path.split('/'), index = -1;
					path = path.slice(1, path.length - 1);

					var findPage = function (parent, slug, callback) {
						this.$.pages.query.orderByChild('parent').equalTo(parent).on('child_added', callback);
					}.bind(this);

					var callback = function () {
						var firstSnapshot;

						return function (snapshot) {
							if (snapshot && !firstSnapshot) {
								var parent = snapshot.child('parent').val(), slug = snapshot.child('slug').val(), key = snapshot.key();

								if (slug === path[index + 1]) {
									firstSnapshot = true;
									index += 1;

									if (index + 1 < path.length) {
										findPage(key, path[index + 1], callback());
									} else {
										this.key = key;
									}
								}
							}
						}.bind(this);
					}.bind(this);

					findPage('', path[0], callback());
				},
				__pageChanged: function () {
					this.async(
						function () {
							if (this._page.length) {
								var page = {};

								for (var i = 0; i < this._page.length; i += 1) {
									page[this._page[i].__firebaseKey__] = Array.isArray(this._page[i]) ? this._page[i] : this._page[i].value;
								}

								this.page = page;
								this.error = false;
							} else {
								this.page = null;
								this.error = true;
							}
						},
						200
					);
				},
				_pageLocation: function () {
					if (!this.key) return '';
					return 'https://ss16-page-press.firebaseio.com/pages/' + this.key;
				},
				_pageTitleChanged: function () {
					document.title = (this.page && this.page.title) ? this.page.title : '404';
				}
			}
		);
	</script>
</dom-module>