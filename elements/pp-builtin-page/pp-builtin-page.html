<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/elements/pp-page-editor/pp-page-editor.html">
<dom-module id="pp-builtin-page">
	<template>
		<style>
			:host {
				display: block;
				width: calc(100vw - 60px);
				height: calc(100vh - 60px);
				font-family: Roboto;
			}

			@media (max-width: 767px) {
				:host {
					width: 100vw;
					height: 100vh;
				}
			}

			paper-material {
				background: white;
			}

			paper-input,
			paper-dropdown-menu {
				width: 300px;
				max-width: 100%;
			}

			paper-dropdown-menu,
			paper-input {
				--paper-input-container-focus-color: #2a9af2;
				--paper-input-container-invalid-color: #d23f31;
			}
		</style>
		<firebase-document app-name="pp-fb" path="/[[slug]]" data="{{page}}"></firebase-document>
		<paper-toast id="toast"></paper-toast>
		<paper-material style="padding: 20px;">
			<h2 style="margin-top: 0;">[[displayName]]</h2>
    	<div id="page">
				<paper-input label="Title" id="title" always-float-label value="{{title}}"></paper-input>
				<paper-dropdown-menu label="Type" always-float-label noink class="self-center" id="typeMenu">
					<paper-listbox class="dropdown-content" id="typeList" attr-for-selected="key" selected="{{pageType}}">
						<template is="dom-repeat" items="[[pageTypes]]">
							<paper-item key$="[[item.$key]]">[[item.name]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<pp-page-editor id="editor" page-type="[[pageType]]" page-blocks="{{blocks}}"></pp-page-editor>
				<div class="horizontal layout">
					<paper-button on-tap="save">Save</paper-button>
					<paper-button on-tap="cancel">Cancel</paper-button>
				</div>
			</div>
		</paper-material>
	</template>
	<script>
		Polymer(
			{
				is: 'pp-builtin-page',
				behaviors: [
					Polymer.IronOverlayBehavior
				],
				hostAttributes: {
					'with-backdrop': '',
					'no-cancel-on-outside-click': '',
					'no-cancel-on-esc-key': ''
				},
				properties: {
					displayName: {
						type: String,
						value: ''
					},
					page: {
						type: Object,
        		observer: '_pageChanged',
        		notify: true
					},
        	pageType: {
        		type: String,
        		observer: '_pageTypeChanged'
        	},
        	title: {
        		type: String
        	},
					pageTypes: {
						type: Array
					},
					blocks: {
						type: Array
					},
					slug: {
						type: String
					}
				},
				cancel: function () {
					this.opened = false;
				},
        save: function () {
					if (this.page) {
						var error = false;

						if (this.title.trim().length === 0) {
							error = 'Pages must have a valid title';
						} else if (!this.$.typeMenu.selectedItem) {
							error = 'Pages must be based on a valid type';
						}

						if (!error) {
							if (!Array.isArray(this.blocks)) this.blocks = [];

							for (var i = 0; i < this.pageTypes.length; i += 1) {
								if (!this.pageTypes[i]) continue;
								if (this.pageType === this.pageTypes[i].$key) {
									var typeBlocks = this.pageTypes[i].blocks;

									for (var j = 0; j < typeBlocks.length; j += 1) {
										if (!this.blocks[j] || this.blocks[j].name === 'none') {
											var block = {name: typeBlocks[j].name};

											if (block.name === 'static') {
												block.type = this.pageTypes[i].$key;
												block.index = j;
											}

											this.set('blocks.' + j, block);
										}
									}

									break;
								}
							}

							this.set('page.title', this.title);
							this.set('page.type', this.pageType);
							this.set('page.blocks', this.blocks);

        			this.$.typeList.selected = null;
        			this.$.toast.text = 'Page changes saved';
        			this.$.toast.open();
						} else {
							this.$.toast.text = error;
							this.$.toast.open();
						}
					}

					this.opened = false;
        },
        _pageChanged: function () {
					if (this.page) {
						this.title = this.page.title;
						this.pageType = this.page.type;
						this.blocks = this.page.blocks;
					} else if (this.page === null) {
						switch (this.slug) {
							case 'error-page':
								this.page = {title: '404'};
								break;
							case 'home-page':
								this.page = {title: 'Home'};
								break;
						}
					}
        },
        _pageTypeChanged: function () {
        	this.blocks = null;
        }
			}
		);
	</script>
</dom-module>