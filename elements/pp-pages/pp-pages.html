<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="/bower_components/iron-list/iron-list.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/image-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/elements/pp-page-editor/pp-page-editor.html">
<link rel="import" href="/elements/pp-builtin-page/pp-builtin-page.html">
<dom-module id="pp-pages">
	<template>
		<style>
			:host {
				display: block;
			}

			@media (min-width: 768px) {
				.page {
					@apply(--layout-horizontal);
				}
			}

			@media (max-width: 767px) {
				.page {
					@apply(--layout-vertical);
				}
			}

			.page:nth-child(even) {
				background: #f5f5f5;
			}

			iron-list {
				min-height: 100px;
			}

			#page {
				margin-bottom: 15px;
				padding: 15px;
				border: 1px solid #ddd;
			}

			paper-input,
			paper-dropdown-menu {
				width: 300px;
				max-width: 100%;
			}

			paper-dropdown-menu,
			paper-input {
				--paper-input-container-focus-color: #2a9af2;
				--paper-input-container-invalid-color: #d23f31;
			}
		</style>
		<iron-ajax url="/firebase.json" last-response="{{firebaseJson}}" auto></iron-ajax>
		<firebase-collection location="[[pagesUrl]]" data="{{pages}}"></firebase-collection>
		<firebase-collection location="[[pageTypesUrl]]" data="{{types}}"></firebase-collection>
		<paper-toast id="toast"></paper-toast>
		<div class="horizontal layout" style="margin-bottom: 15px;">
			<paper-button on-tap="add">Add</paper-button>
			<paper-button on-tap="homePage">Home Page</paper-button>
			<paper-button on-tap="errorPage">404 Page</paper-button>
		</div>
		<pp-builtin-page id="homePage" slug="home-page"></pp-builtin-page>
		<pp-builtin-page id="errorPage" slug="error-page"></pp-builtin-page>
    <div hidden$="[[!page]]" id="page">
			<paper-input label="Title" id="title" always-float-label></paper-input>
			<paper-dropdown-menu label="Type" always-float-label noink class="self-center" id="typeMenu">
				<paper-listbox class="dropdown-content" id="typeList" attr-for-selected="key" selected="{{type}}">
					<template is="dom-repeat" items="[[types]]">
						<paper-item key$="[[item.__firebaseKey__]]">[[item.name]]</paper-item>
					</template>
				</paper-listbox>
			</paper-dropdown-menu>
			<pp-page-editor id="editor" type="[[type]]" page-blocks="{{blocks}}"></pp-page-editor>
			<div class="horizontal layout">
				<paper-button on-tap="save">Save</paper-button>
				<paper-button on-tap="cancel">Cancel</paper-button>
				<paper-button on-tap="delete">Delete</paper-button>
			</div>
    </div>
		<iron-list items="[[orderedPages]]" as="page">
			<template>
			<div class="page">
				<div style="padding: 15px;"><template is="dom-repeat" items="[[page.ancestors]]" as="ancestor">â€”&nbsp;</template>[[page.title]] <em>([[page.slug]])</em></div>
				<div class="flex"></div>
				<div class="horizontal layout" style="padding: 5px;">
					<paper-icon-button icon="image:edit" on-tap="_edit" page-index$="[[index]]"></paper-icon-button>
					<paper-icon-button icon="open-in-new" on-tap="_view" page-index$="[[index]]"></paper-icon-button>
				</div>
			</div>
			</template>
		</iron-list>
	</template>
	<script>
		Polymer(
			{
				is: 'pp-pages',
				properties: {
					firebaseJson: {
						type: Object
					},
					firebaseUrl: {
						type: String,
						computed: '_computeFirebaseUrl(firebaseJson.firebase)'
					},
					pages: {
						type: Array
					},
					pageIndexesByFirebaseKey: {
						type: Object,
						computed: '_computePageIndexesByFirebaseKey(pages.*)'
					},
					orderedPages: {
						type: Array
					},
        	index: {
        		type: Number
        	},
        	page: {
        		type: Object,
        		value: null,
        		computed: '_computePage(index)',
        		observer: '_pageChanged'
        	},
        	type: {
        		type: String,
        		observer: '_typeChanged'
        	},
        	title: {
        		type: String
        	},
					types: {
						type: Array
					},
					blocks: {
						type: Array
					},
					pagesUrl: {
						type: String,
						computed: '_computePagesUrl(firebaseUrl)'
					},
					pageTypesUrl: {
						type: String,
						computed: '_computePageTypesUrl(firebaseUrl)'
					}
				},
				observers: [
					'_pagesChanged(pages.*)'
				],
				homePage: function () {
					this.$.homePage.opened = true;
				},
				errorPage: function () {
					this.$.errorPage.opened = true;
				},
        add: function () {
        	this.push(
        		'pages',
        		{
        			title: 'New Page',
        			slug: 'new-page',
        			parent: ''
        		}
        	);

					this.async(
						function () {
							this.index = this.pages.length - 1;
						},
						100
					);

					this.$.toast.text = 'Page added';
					this.$.toast.open();
        },
        cancel: function () {
        	this.index = null;
					this.$.toast.text = 'Page changes discarded';
					this.$.toast.open();
        },
				_computeFirebaseUrl: function () {
					if (this.firebaseJson && this.firebaseJson.firebase) return 'https://' + this.firebaseJson.firebase + '.firebaseio.com/';
				},
				_computePagesUrl: function () {
					if (this.firebaseUrl) return this.firebaseUrl + 'pages/';
				},
				_computePageTypesUrl: function () {
					if (this.firebaseUrl) return this.firebaseUrl + 'page-types/';
				},
        _edit: function (event) {
					var target = Polymer.dom(event).localTarget, index = +target.getAttribute('page-index');
					if (index >= 0) this.index = this.pageIndexesByFirebaseKey[this.orderedPages[index].__firebaseKey__];
        },
				_view: function (event) {
					var target = Polymer.dom(event).localTarget, index = +target.getAttribute('page-index');

					if (index >= 0) {
						var page = this.orderedPages[index];

						if (page) {
							var path = '/';

							for (var i = page.ancestors.length - 1; i >= 0; i -= 1) {
								path += page.ancestors[i].slug + '/';
							}

							path += page.slug + '/';
							window.open(path);
						}
					}
				},
				_pagesChanged: function () {
					this.async(
						function () {
							var pagesHierarchical = [], childPages = [], pagesById = {};

							for (var i = 0; i < this.pages.length; i += 1) {
								var srcPage = this.pages[i], srcPageKeys = Object.keys(srcPage);
								var newPage = {children: [], ancestors: []};

								for (var j = 0; j < srcPageKeys.length; j += 1) {
									newPage[srcPageKeys[j]] = srcPage[srcPageKeys[j]];
								}

								pagesById[srcPage.__firebaseKey__] = newPage;

								if (!newPage.parent) {
									pagesHierarchical.push(newPage);
								} else {
									childPages.push(newPage);
								}
							}

							for (i = 0; i < childPages.length; i += 1) {
								pagesById[childPages[i].parent].children.push(childPages[i]);

								(
									function (page) {
										var ancestor = pagesById[page.parent];

										while (ancestor) {
											page.ancestors.push(ancestor);
											ancestor = pagesById[ancestor.parent];
										}
									}
								)(childPages[i]);
							}

							var pagesFlat = [];

							function flattenPages (pages, skipAddingParent) {
								for (var i = 0; i < pages.length; i += 1) {
									if (!skipAddingParent) pagesFlat.push(pages[i]);

									if (pages[i].children.length) {
										var childrenByTitle = {};

										for (var j = 0; j < pages[i].children.length; j += 1) {
											if (!childrenByTitle[pages[i].children[j].title]) childrenByTitle[pages[i].children[j].title] = [];
											childrenByTitle[pages[i].children[j].title].push(pages[i].children[j]);
										}

										var titles = Object.keys(childrenByTitle);
										titles.sort();
										var children = [];

										for (j = 0; j < titles.length; j += 1) {
											for (var k = 0; k < childrenByTitle[titles[j]].length; k += 1) {
												children.push(childrenByTitle[titles[j]][k]);
											}
										}

										flattenPages(children);
									}
								}
							}

							flattenPages([{children: pagesHierarchical}], true);
							this.orderedPages = pagesFlat;
						},
						1000
					);
				},
				_path: function (index) {
					if (index >= 0) {
						var page = this.orderedPages[index];

						if (page) {
							path = '/';

							for (var i = page.ancestors.length - 1; i >= 0; i -= 1) {
								path += page.ancestors[i].slug + '/';
							}

							path += page.slug + '/';
						}
					}

					return path;
				},
				delete: function () {
					if (this.page) {
						var pageIndexesByFirebaseKey = {};

						for (var i = 0; i < this.pages.length; i += 1) {
							pageIndexesByFirebaseKey[this.pages[i].__firebaseKey__] = i;
						}

						if (page.children) {
							for (i = 0; i < page.children.length; i += 1) {
								var childIndex = pageIndexesByFirebaseKey[page.children[i].__firebaseKey__];
								this.set('pages.' + childIndex + '.parent', this.page.parent);
							}
						}

						this.splice('pages', this.index, 1);
	        	this.index = null;
						this.$.toast.text = 'Page deleted';
						this.$.toast.open();
					}
				},
        save: function () {
					if (this.page) {
						var error = false;

						if (this.$.title.value.trim().length === 0) {
							error = 'Pages must have a valid title';
						} else if (!this.$.typeMenu.selectedItem) {
							error = 'Pages must be based on a valid type';
						}

						if (!error) {
							if (!Array.isArray(this.blocks)) this.blocks = [];

							for (var i = 0; i < this.types.length; i += 1) {
								if (this.type === this.types[i].__firebaseKey__) {
									var typeBlocks = this.types[i].blocks;

									for (var j = 0; j < typeBlocks.length; j += 1) {
										if ((!this.blocks[j] || this.blocks[j].name === 'none') && typeBlocks[j]) {
											var block = {name: typeBlocks[j].name};

											if (block.name === 'static') {
												block.type = this.types[i].__firebaseKey__;
												block.index = j;
											}

											this.set('blocks.' + j, block);
										}
									}

									break;
								}
							}

							this.set('pages.' + this.index + '.title', this.$.title.value);
							this.set('pages.' + this.index + '.type', this.type);
							this.set('pages.' + this.index + '.blocks', this.blocks);

							this.set(
								'pages.' + this.index + '.slug',
								//slugify: https://gist.github.com/mathewbyrne/1280286
								this.$.title.value.toString().toLowerCase().trim()
									.replace(/&/g, '-and-')			// Replace & with 'and'
									.replace(/[\s\W-]+/g, '-')	// Replace spaces, non-word characters and dashes with a single dash (-)
									.replace(/-$/, '')					// Remove last floating dash if exists)
							);

        			this.index = null;
        			this.$.typeList.selected = null;
        			this.$.toast.text = 'Page changes saved';
        			this.$.toast.open();
						} else {
							this.$.toast.text = error;
							this.$.toast.open();
						}
					}
        },
        _computePage: function () {
        	return this.pages[this.index];
        },
        _pageChanged: function () {
					if (this.page) {
						this.$.title.value = this.page.title;
						this.type = this.page.type;
						this.blocks = this.page.blocks;
					}
        },
        _typeChanged: function () {
        	this.blocks = null;
        },
        _computePageIndexesByFirebaseKey: function () {
        	var pageIndexesByFirebaseKey = {};

					for (var i = 0; i < this.pages.length; i += 1) {
						pageIndexesByFirebaseKey[this.pages[i].__firebaseKey__] = i;
					}

					return pageIndexesByFirebaseKey;
        }
			}
		);
	</script>
</dom-module>