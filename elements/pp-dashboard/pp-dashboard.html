<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/font-roboto/roboto.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/device-icons.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="/bower_components/firebase-element/firebase-document.html">
<link rel="import" href="/bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="/bower_components/iron-page-url/iron-page-url.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="/elements/pp-page-layouts/pp-page-layouts.html">
<link rel="import" href="/elements/pp-page-types/pp-page-types.html">
<link rel="import" href="/elements/pp-pages/pp-pages.html">
<dom-module id="pp-dashboard">
	<template>
		<style>
			:host {
				display: block;
				width: 100vw;
				height: 100vh;
				font-family: Roboto;
			}

			iron-pages {
				padding: 20px;
			}

			iron-pages section > :first-child {
				margin-top: 0;
			}

			iron-pages section > :last-child {
				margin-bottom: 0;
			}

			#logout {
				margin: 0;
				border-radius: 0;
			}

			#navigation a {
				display: block;
				color: inherit;
				text-decoration: none;
			}

			#navigation paper-item[selected] {
				font-weight: bold;
			}

			paper-toolbar {
				--paper-toolbar-background: #2A9AF2;
			}

			#login-backdrop {
				background: #2A9AF2;
			}

			#login-backdrop paper-button {
				margin: 0;
			}

			#login-backdrop paper-button:not([disabled]) {
				color: #2A9AF2;
			}

			#login-backdrop h1 {
				color: white;
			}

			paper-tabs {
				--paper-tabs-selection-bar-color: #2A9AF2;
			}
			paper-tab {
				--paper-tab-ink: #2A9AF2;
			}
		</style>
		<iron-ajax url="/firebase.json" last-response="{{firebaseJson}}" auto></iron-ajax>
		<firebase-auth location="[[firebaseUrl]]" user="{{user}}" provider="google" id="auth"></firebase-auth>
		<firebase-document location="[[connectionUrl]]" id="connection" data="{{connected}}"></firebase-document>
		<firebase-document location="[[adminsUrl]]" id="admins" data="{{admins}}"></firebase-document>
		<iron-page-url path="{{path}}" url-space-regex="^/dashboard/"></iron-page-url>
		<paper-drawer-panel force-narrow id="drawerPanel" hidden$="[[!user]]">
			<paper-header-panel drawer>
				<paper-toolbar>
					<div class="title" style="line-height: 22px; margin-left: 0;"><strong><em>PagePress</em></strong>&nbsp;Navigation</div>
				</paper-toolbar>
				<div class="fit vertical layout">
					<div id="navigation" on-tap="_closeDrawer">
						<a href="/dashboard/">
							<paper-item page="Overview" selected$="[[_equalTo(page, 'Overview')]]">Overview</paper-item>
						</a>
						<a href="/dashboard/page-layouts/">
							<paper-item page="Page Layouts" selected$="[[_equalTo(page, 'Page Layouts')]]">Page Layouts</paper-item>
						</a>
						<a href="/dashboard/page-types/">
							<paper-item page="Page Types" selected$="[[_equalTo(page, 'Page Types')]]">Page Types</paper-item>
						</a>
						<a href="/dashboard/pages/">
							<paper-item page="Pages" selected$="[[_equalTo(page, 'Pages')]]">Pages</paper-item>
						</a>
					 </div>
					<div class="flex"></div>
					<div class="horizontal layout">
						<paper-button id="logout" class="flex" on-tap="logout">Log Out</paper-button>
					</div>
				</div>
			</paper-header-panel>
			<paper-header-panel main>
				<paper-toolbar>
					<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
					<div class="title horizontal layout" style="line-height: 22px;">
						<span><strong><em>PagePress</em></strong>&nbsp;Dashboard</span>
						<span class="flex"></span>
						<iron-icon class="self-center" icon="device:signal-wifi-0-bar" hidden$="[[connected]]"></iron-icon>
						<iron-icon class="self-center" icon="device:network-wifi" hidden$="[[!connected]]"></iron-icon>
					</div>
				</paper-toolbar>
				<template is="dom-if" if="[[user]]">
					<iron-pages selected="[[page]]" attr-for-selected="page">
						<section page="Overview">
							<h1>Overview</h1>
							<p>Welcome!	PagePress aims to be a content management system (CMS) reimagined as a single-page application (SPA).  Current functionality is organized around page layouts, page types, and the pages themselves.</p>
							<h3>Page Layouts</h3>
							<p>Reusable layouts arranged in rows and columns with options for how the columns should be justified.  A single layout can be shared among multiple page types.</p>
							<h3>Page Types</h3>
							<p>Take a specified layout and configure it with content.  Content (on a per-block basic) can be static across all page instances of a page type or page-specific.  A single page type can be shared among multiple pages.</p>
							<h3>Pages</h3>
							<p>Take a specified type and configure it with content.  Static content may be inherited from the type.</p>
							<div style="margin-top: 50px;">To get started, click the <iron-icon icon="menu"></iron-icon> button at the top left.</div>
						</section>
						<section page="Page Layouts">
							<h1>Page Layouts</h1>
							<pp-page-layouts></pp-page-layouts>
						</section>
						<section page="Page Types">
							<h1>Page Types</h1>
							<pp-page-types></pp-page-types>
						</section>
						<section page="Pages">
							<h1>Pages</h1>
							<pp-pages></pp-pages>
						</section>
					</iron-pages>
				 </template>
				<div class="fit vertical layout end-justified" style="pointer-events: none;">
					<paper-toast id="toast" style="pointer-events: all;" class="self-start"></paper-toast>
				</div>
			</paper-header-panel>
		</paper-drawer-panel>
		<div class="fit horizontal layout center-justified" hidden$="[[user]]" id="login-backdrop">
			<div class="self-center vertical layout">
				<h1 style="font-weight: normal;"><strong><em>PagePress</em></strong>&nbsp;Dashboard</h1>
				<paper-material elevation="5" style="background: white;">
					<div style="padding: 20px;">
						<gold-email-input label="Email address" always-float-label required auto-validate id="loginEmail"></gold-email-input>
						<paper-input label="Password" always-float-label required type="password" id="loginPassword"></paper-input>
						<div class="horizontal layout">
							<paper-button on-tap="login" id="loginButton">Log In</paper-button>
							<div class="flex"></div>
							<paper-button on-tap="register" id="registerButton">Register</paper-button>
						</div>
					</div>
				</paper-material>
			</div>
			<paper-toast id="loginToast" style="pointer-events: all;" class="self-start"></paper-toast>
		</div>
	</template>
	<script>
		Polymer(
			{
				is: 'pp-dashboard',
				properties: {
					firebaseJson: {
						type: Object
					},
					firebaseUrl: {
						type: String,
						computed: '_computeFirebaseUrl(firebaseJson.firebase)'
					},
					path: {
						type: String,
						observer: '_pathChanged'
					},
					page: {
						type: String
					},
					user: {
						type: Object
					},
					connected: {
						type: Boolean,
						observer: '_connectedChanged'
					},
					connectionUrl: {
						type: String,
						computed: '_computeConnectionUrl(firebaseUrl)'
					},
					loginPage: {
						type: Number,
						value: 0
					},
					adminsUrl: {
						type: String,
						computed: '_computeAdminsUrl(firebaseUrl)'
					},
					admins: {
						type: Object
					}
				},
				login: function () {
					if (!this.user) {
						this.$.loginEmail.disabled = true;
						this.$.loginPassword.disabled = true;
						this.$.loginButton.disabled = true;
						this.$.registerButton.disabled = true;

						this.$.auth.ref.authWithPassword(
							{
								email: this.$.loginEmail.value,
								password: this.$.loginPassword.value
							},
							function (error, authData) {
								this.$.loginEmail.disabled = false;
								this.$.loginPassword.disabled = false;
								this.$.loginButton.disabled = false;
								this.$.registerButton.disabled = false;

								if (error) {
									this.$.loginToast.text = 'Invalid email address and / or password';
									this.$.loginToast.open();
								} else {
									if (this.admins === null) {
										var admins = {};
										admins[this.user.uid] = true;
										this.admins = admins;
									}

									this.$.loginEmail.value = '';
									this.$.loginPassword.value = '';

									this.async(
										function () {
											this.$.toast.text = 'Login successful';
											this.$.toast.open();
										},
										100
									);
								}
							}.bind(this)
						);
					}
				},
				register: function () {
					if (!this.user) {
						if (!this.$.loginEmail.value) {
							this.$.loginEmail.invalid = true;
						}

						if (!this.$.loginPassword.value) {
							this.$.loginPassword.invalid = true;
						} else {
							this.$.loginPassword.invalid = false;
						}

						if (this.$.loginEmail.invalid && this.$.loginPassword.invalid) {
							this.$.loginToast.text = 'Invalid email address and password';
							this.$.loginToast.open();
						} else if (this.$.loginEmail.invalid) {
							this.$.loginToast.text = 'Invalid email address';
							this.$.loginToast.open();
						} else if (this.$.loginPassword.invalid) {
							this.$.loginToast.text = 'Invalid password';
							this.$.loginToast.open();
						} else {
							this.$.loginEmail.disabled = true;
							this.$.loginPassword.disabled = true;
							this.$.loginButton.disabled = true;
							this.$.registerButton.disabled = true;

							this.$.auth.ref.createUser(
								{
									email: this.$.loginEmail.value,
									password: this.$.loginPassword.value
								},
								function (error) {
									this.$.loginEmail.disabled = false;
									this.$.loginPassword.disabled = false;
									this.$.loginButton.disabled = false;
									this.$.registerButton.disabled = false;

									if (error) {
										switch (error.code) {
											case 'EMAIL_TAKEN':
												this.$.loginToast.text = 'Email address already in use';
												break;
											case 'INVALID_EMAIL':
												this.$.loginToast.text = 'Invalid email address';
												break;
											default:
												this.$.loginToast.text = 'Error creating user';
												break;
										}

										this.$.loginToast.open();
									} else {
										this.$.loginToast.text = 'Registration successful';
										this.$.loginToast.open();
										this.login();
									}
								}.bind(this)
							);
						}
					}
				},
				logout: function () {
					if (this.user) this.$.auth.logout();
				},
				_computeAdminsUrl: function () {
					if (this.firebaseUrl) return this.firebaseUrl + 'admins/';
				},
				_computeConnectionUrl: function () {
					if (this.firebaseUrl) return this.firebaseUrl + '.info/connected';
				},
				_computeFirebaseUrl: function () {
					if (this.firebaseJson && this.firebaseJson.firebase) return 'https://' + this.firebaseJson.firebase + '.firebaseio.com/';
				},
				_closeDrawer: function () {
					this.$.drawerPanel.closeDrawer();
				},
				_pathChanged: function () {
					//Make sure path ends in a slash
					if (this.path.charAt(this.path.length - 1) !== '/') {
						this.path += '/';
						history.replaceState(null, null, this.path);
						return;
					}

					//If path is not a dashboard path, reload
					if (this.path.substring(0, 11) !== '/dashboard/') {
						window.location.reload();
						return;
					}

					var page = 'Overview';

					switch (this.path) {
						case '/dashboard/page-layouts/':
							page = 'Page Layouts';
							break;
						case '/dashboard/page-types/':
							page = 'Page Types';
							break;
						case '/dashboard/pages/':
							page = 'Pages';
							break;
					}

					this.page = page;
				},
				_equalTo: function (a, b) {
					return a === b;
				},
				_connectedChanged: function () {
					if (this.connected) {
						this.$.toast.text = 'Network connection established';
					} else {
						this.$.toast.text = 'Network connection lost';
					}

					this.$.toast.open();
				}
			}
		);
	</script>
</dom-module>